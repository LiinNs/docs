# 窗口函数

~~~sql
SELECT
	* 
FROM
	( SELECT ROW_NUMBER() over ( PARTITION BY user_id ORDER BY bet_amount DESC ) AS row_num, order_id, user_id, bet_amount, create_time FROM t_order ) t;
~~~

## 窗口函数分类

- 序号函数：row_number() / rank() / dense_rank()
- 分布函数：percent_rank() / cume_dist()
- 前后函数：lag() / lead()
- 头尾函数：first_val() / last_val()
- 其他函数：nth_value() / nfile()

## 窗口函数如何使用

> 函数名（[expr]） over子句

其中，over是关键字，用来指定函数执行的窗口范围，如果后面括号中什么都不写，则意味着窗口包含满足where条件的所有行，窗口函数基于所有行进行计算；如果不为空，则支持以下四种语法来设置窗口：

- window_name：给窗口指定一个别名，如果SQL中涉及的窗口较多，采用别名可以看起来更清晰易读。上面例子中如果指定一个别名w，则改写如下：

~~~sql
SELECT
	* 
FROM
	(
	SELECT
		ROW_NUMBER() over w AS row_num,
		order_id,
		user_id,
		bet_amount,
		create_time 
	FROM
	order_tab WINDOW w AS ( PARTITION BY user_id ORDER BY bet_amount DESC ) 
	) t;
~~~

- partition子句：窗口按照那些字段进行分组，窗口函数在不同的分组上分别执行。上面的例子就按照用户id进行了分组。在每个用户id上，按照order by的顺序分别生成从1开始的顺序编号。
- order by子句：按照哪些字段进行排序，窗口函数将按照排序后的记录顺序进行编号。可以和partition子句配合使用，也可以单独使用。上例中二者同时使用，如果没有partition子句，则会按照所有用户的订单金额排序来生成序号。
- frame子句：frame是当前分区的一个子集，子句用来定义子集的规则，通常用来作为滑动窗口使用。比如要根据每个订单动态计算包括本订单和按时间顺序前后两个订单的平均订单金额，则可以设置如下frame子句来创建滑动窗口：

~~~sql
SELECT
	* 
FROM
	(
	SELECT
		AVG(bet_amount) over w AS avg_num,
		order_id,
		user_id,
		bet_amount,
		create_time 
	FROM
	t_order WINDOW w AS ( PARTITION BY user_id ORDER BY bet_amount DESC ROWS BETWEEN 1 preceding and 1 following) 
	) t;
~~~

对于滑动窗口的范围指定，有两种方式，基于行和基于范围，具体区别如下：

### 基于行

通常使用BETWEEN frame_start AND frame_end语法来表示行范围，frame_start和frame_end可以支持如下关键字，来确定不同的动态行记录：

- CURRENT ROW 边界是当前行，一般和其他范围关键字一起使用
- UNBOUNDED PRECEDING 边界是分区中的第一行
- UNBOUNDED FOLLOWING 边界是分区中的最后一行
- expr PRECEDING  边界是当前行减去expr的值
- expr FOLLOWING  边界是当前行加上expr的值

比如，下面都是合法的范围：
 
- rows BETWEEN 1 PRECEDING AND 1 FOLLOWING 窗口范围是当前行、前一行、后一行一共三行记录。
- rows  UNBOUNDED FOLLOWING 窗口范围是当前行到分区中的最后一行。
- rows BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING 窗口范围是当前分区中所有行，等同于不写。

### 基于范围

和基于行类似，但有些范围不是直接可以用行数来表示的，比如希望窗口范围是一周前的订单开始，截止到当前行，则无法使用rows来直接表示，此时就可以使用范围来表示窗口：INTERVAL 7 DAY PRECEDING。Linux中常见的最近1分钟、5分钟负载是一个典型的应用场景。

有的函数不管有没有frame子句，它的窗口都是固定的，也就是前面介绍的静态窗口，这些函数包括如下：

- CUME_DIST()
- DENSE_RANK()
- LAG()
- LEAD()
- NTILE()
- PERCENT_RANK()
- RANK()
- ROW_NUMBER()

## 序号函数 row_number() / rank() / dense_rank()

~~~sql
SELECT
	* 
FROM
	(
	SELECT
		row_number() over w AS r_row,
		rank() over w AS r_rank,
		dense_rank() over w AS dr_rank,
		order_id,
		user_id,
		bet_amount,
		create_time 
	FROM
	t_order 
	WINDOW w AS ( PARTITION BY user_id ORDER BY bet_amount DESC ) 
	) t;
~~~

## 分布函数 percent_rank() / cume_dist()

## references

[窗口函数](https://dbaplus.cn/news-11-2258-1.html)